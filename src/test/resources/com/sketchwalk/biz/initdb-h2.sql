CREATE TABLE medias (
    ID INT NOT NULL IDENTITY,
    MIME_TYPE VARCHAR(256) NOT NULL,
    DATA VARBINARY NOT NULL
);

CREATE TABLE users (
    ID INT NOT NULL IDENTITY,
    USERNAME VARCHAR(256) NOT NULL,
    EMAIL VARCHAR(256) NOT NULL,
    PASSWORD_HASH VARCHAR(64),
    DISPLAY_NAME VARCHAR(256) NOT NULL,
    PROFILE_PICTURE INT,
    COVER_PICTURE INT,

    FOREIGN KEY (PROFILE_PICTURE) REFERENCES medias(ID),
    FOREIGN KEY (COVER_PICTURE) REFERENCES medias(ID)
);

CREATE UNIQUE INDEX users_username ON users(USERNAME);
CREATE UNIQUE INDEX users_email ON users(EMAIL);

CREATE TABLE groups (
    ID INT NOT NULL IDENTITY,
    NAME VARCHAR(256) NOT NULL,
    DISPLAY_NAME VARCHAR(256) NOT NULL,
    DESCRIPTION TEXT
);

CREATE UNIQUE INDEX groups_name ON groups(NAME);

CREATE TABLE groups_users (
    GROUP_ID INT NOT NULL,
    USER_ID INT NOT NULL,

    PRIMARY KEY (GROUP_ID,USER_ID),
    FOREIGN KEY (GROUP_ID) REFERENCES groups(ID),
    FOREIGN KEY (USER_ID) REFERENCES users(ID)
);

CREATE UNIQUE INDEX groups_users_uid_gid ON groups_users(USER_ID,GROUP_ID);

----------------------------------------------------------------------------------
-- Site structure
----------------------------------------------------------------------------------

CREATE TABLE pages (
    ID INT NOT NULL IDENTITY,
    TEMPLATE VARCHAR(32) NOT NULL
);

CREATE TABLE pages_pages (
    PARENT_ID INT NOT NULL,
    NAME VARCHAR(32) NOT NULL,
    CHILD_ID INT NOT NULL,

    PRIMARY KEY (PARENT_ID,NAME)
);

CREATE UNIQUE INDEX pages_pages_child_parent ON pages_pages(CHILD_ID,PARENT_ID);

CREATE TABLE page_versions (
    ID INT NOT NULL IDENTITY,
    TITLE VARCHAR NOT NULL
);

CREATE TABLE pages_page_versions (
    PAGE_ID INT NOT NULL,
    LANGUAGE VARCHAR(10) NOT NULL,
    VERSION_ID INT NOT NULL,

    PRIMARY KEY (PAGE_ID,LANGUAGE),
    FOREIGN KEY (PAGE_ID) REFERENCES pages(ID),
    FOREIGN KEY (VERSION_ID) REFERENCES page_versions(ID)
);

CREATE INDEX pages_page_versions_version_page
        ON pages_page_versions(VERSION_ID,PAGE_ID);

CREATE TABLE sites (
    ID INT NOT NULL IDENTITY,
    NAME VARCHAR(32) NOT NULL,
    CURRENT_REV_ID INT
);

CREATE UNIQUE INDEX sites_name ON sites(NAME);

CREATE TABLE site_revisions (
    ID INT NOT NULL IDENTITY,
    BASE_REV_ID INT,
    SITE_ID INT NOT NULL,
    TIMESTAMP TIMESTAMP NOT NULL,
    ROOT_PAGE_ID INT NOT NULL,

    FOREIGN KEY (BASE_REV_ID) REFERENCES site_revisions(ID),
    FOREIGN KEY (SITE_ID) REFERENCES sites(ID),
    FOREIGN KEY (ROOT_PAGE_ID) REFERENCES pages(ID)
);

ALTER TABLE sites
ADD CONSTRAINT fk_sites_current_rev_id
FOREIGN KEY (CURRENT_REV_ID) REFERENCES site_revisions(ID);
